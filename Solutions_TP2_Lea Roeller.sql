/*
 *		TECH220712 -- Créer et exploiter des bases de données									
 *		
 *		HEC Montréal, A2023
 *		Travail Pratique 2	
 *		
 *		
 *		Instructions de remise : 
 *			- Répondre aux questions directement dans ce fichier SQL
 *			- Remettre via ZoneCours dans l'outil de Remise de travaux
 *
 *		Instructions supplémentaires 
 *			- Seule la derniere question doit utiliser une jointure  (JOIN).
 *			- Pour les autres questions, il ne faut que des requêtes de type SELECT (SELECT, FROM, WHERE, GROUP BY....et quelques fonctions d'agrégation) sans jointures.
 *			- Assurez-vous d'avoir la base d'AdventureWorks2019 installée sur votre poste!
 *			- À moins d'avis contraire, on vous demande 1 seule requête qui retourne les résultats demandés par question.
 *
 *		Correction : 
 *			- 12.5% de la note finale, /12.5
 *			- Une question qui génère une erreur (ne s'exécute pas) se verra automatiquement attribuer la note de 0.
 *
 */


/*
	- Mise en contexte : 
	-	La compagnie AdventureWorks manque de ressources TI. On vient également d'apprendre que 
	-	la personne responsable de répondre aux demandes ad-hoc des utilisateurs d'affaires a dû 
	-	s'absenter pour une durée indéterminée. Étant la seule personne avec  des compétences en
	-	bases de données sur place, vous prenez la responsabilité  de répondre aux demandes des 
	-	utilisateurs d'affaires. 

*/


USE AdventureWorks2019;
GO


/*
=> Question 1 
	La directrice des ventes vient vous voir à votre bureau et vous demande une liste restreinte de produits finis qui peuvent 
	être vendus à l'heure actuelle (i.e. pas de date prévue de fin de vente). Elle veut seulement les produits qui sont fabriqués
	chez Adventureworks et non achetés à l'extérieur. Elle veut aussi les produits pour lesquelles le prix de vente est défini et 
	les produits pour lesquelles la marge de profit est au moins 30 dollars. 

	Elle veut uniquement les produits de couleur noir, rouge ou argent ou qui n'ont pas de couleur définie dans la base de données.
	Elle veut aussi uniquement les produits qui ont un style défini.
	Concernant les produits unisexes, la liste doit contenir seulement ceux dont la classe de produit est "low". 
	Pour ce qui est des produits pour femmes, seuls ceux dont la classe est "medium" doivent se retrouver dans la liste.
	Pour ce qui est des produits pour hommes, seuls ceux dont la classe est "medium" ou "high" doivent se retrouver dans la liste.
	Finalement, elle veut les produits pour lesquelles le poids du produit est mesuré en livres (LB). 

	Le responsable des ventes prend également la peine de vous indiquer que la liste de produits résultante devrait 
	contenir uniquement :
	- Le nom du produit
	- Le numéro du produit
	- Le prix affiché
	- Le style
	- La classe
	- La couleur
*/

/*les informations sur AdventureWork sont de ce document: https://dataedo.com/download/AdventureWorks.pdf*/

SELECT 
    Name AS [Le nom du produit],
    ProductNumber AS [Le numéro du produit],
    ListPrice AS [Prix affiché],
    Style AS [Le style],
    Class AS [La classe],
    Color AS [La couleur]
FROM
    Production.Product
WHERE
    MakeFlag = 1 -- Elle veut seulement les produits qui sont fabriqués chez Adventureworks et non achetés à l'extérieur
	AND ProductLine = 'R'
	AND ListPrice >= 30
	AND (Color IN ('Black', 'Red', 'Silver') OR Color IS NULL)
	 AND (
        (Class = 'L') OR
        (Class = 'M' AND Style ='W') OR -- femmes 
        (Class IN ('M', 'H') AND Style ='M') -- hommes 
		 )
    AND WeightUnitMeasureCode = 'LB';


/*
=> Question 2 
	La directrice des achats aimerait travailler avec vous pour faire une analyse des employés qui 
	travaillent chez AdventureWorks qui on fait des achats. Elle souhaite que l'analyse se concentre uniquement sur les emplpoyés ayant fait des 
	bons de commandes (Purchase Order) pour des achats pendant les trois premiers trimestres de 2013 (Janvier à Octobre 2013).

	Elle souhaite obtenir l'information suivante :
	- ID de l'employés
	- Nombre d'achats effecté par cet employé
	- Montant total des achats (avant taxes et transport)
	- Montant moyen des achats (avant taxes et transport)

	Elle souhaite que seuls les employés ayant effectué des achats durant cette période soient présents dans le tableau résultant.
	
	Montrez le résultat dans un ordre croissant de montant total des achats.
	Assurez-vous que les colonnes du résultat final aient des noms appropriés.
*/



SELECT 
    VendorID AS [ID de l'employés], 
    COUNT(PurchaseOrderID) AS [Nombre d'achats effecté par cet employé],
    SUM(SubTotal) AS [Montant total des achats],
    AVG(SubTotal) AS [Montant moyen des achats]
FROM Purchasing.PurchaseOrderHeader 
WHERE YEAR(OrderDate) = 2013 AND MONTH(OrderDate) <= 9 -- seulement les premiere trois trimestres de 2013
GROUP BY VendorID
ORDER BY [Montant total des achats] ASC;


/*
=> Question 3 
	Votre collègue vous indique que l'attribut ProductLine de la table de produits (Production.Product) prends uniquement les valeurs R, M, T ou S dans la base de données. 
	A-t-il raison?
	Que lui répondez-vous (1 phrase simple)? 
	Faites une requête qui vous permet de vérifier le nombre d'attributs associés à chaque valeur de ProductLine.

*/

SELECT 
   ProductLine 
FROM
    Production.Product
GROUP BY ProductLine;
    
-- Mon collègue a raison qu'il prend uniquement les valeurs R, M, T ou S, mais il y aussi des valeurs NULL! 


/*
=>Question 4 

	La directrice des ressources humaines entend votre conversation avec votre collègue et saisi l'opportunité pour vous demander de l'information 
	sur les différents titres de postes chez AdventureWorks. 

	Elle souhaite avoir l'information suivante pour chacun des titres de postes:
	- La titre de poste
	- Le nombre d'employés associés au poste
	- Le nombre d'heures de vacances disponibles moyen
	- Le nombre d'heures de maladie disponibles moyen
	- La nombre d'heures d'abscence total disponibles (maladie et vacances) moyen

	Elle veut que la liste résultante ne prennent en compte que les employés actifs et qui sont payés à l'heure. 

	Elle souhaite aussi conserver uniquement les titres de postes qui ont un nombre total d'heures d'abscence disponibles de 100 et plus.

	Prenez soin de nommer correctement les colonnes en suivant l'exemple ci-dessous. 
	 _____________________________________________________________________________________________________________________________________________________
	|	Titre de poste	|	Nombre d'employés	|  Moyenne des heures de vacances	| Moyenne des heures de maladie | Moyenne des heures d'abscence totale |
	-----------------------------------------------------------------------------------------------------------------------------
	|		 ...		|       ...				|           ...				        |        ...			        |		 ...				          |
*/

SELECT
	JobTitle AS [Titre de poste],
	COUNT(JobTitle) AS [Nombre d'employés],
    AVG (VacationHours) AS [Moyenne des heures de vacances],
    AVG(SickLeaveHours) AS [Moyenne des heures de maladie],
    AVG(VacationHours + SickLeaveHours) AS [Moyenne des heures d'absence totale]
FROM
    HumanResources.Employee
WHERE
    CurrentFlag = 1  --  Elle veut que la liste résultante ne prennent en compte que les employés actifs et qui sont payés à l'heure. 
GROUP BY
    JobTitle
HAVING
    SUM(VacationHours + SickLeaveHours) >= 100 	-- Elle souhaite aussi conserver uniquement les titres de postes qui ont un nombre total d'heures d'abscence disponibles de 100 et plus.

ORDER BY
    JobTitle;


		
/*
=>Question 5 
	La directrice des ventes demande maintenant votre aide pour une courte analyse concernant les cartes de crédits.
	
	Elle est en effet intéressée à savoir si certains numéros de cartes de crédit présents dans les tables de ventes 
	sont associés à des employés, vendeurs ou non, d'AdventureWorks (PersonType). 
	
	Elle vous dit que les employés ne devraient pas être liés à des cartes de crédits, et veut donc vérifier que c'est bien le cas.
	Elle vous demande donc de lui sortir le nombre de cartes de crédit qui sont associées à chacun des persontype présents dans dans la BD.

	Elle veut que tous les persontype soient présents et que les noms des colonnes soient appropriés.

	Et demande aussi que les résultats soient classés en présentant les persontype qui ont le plus de cartes de crédit associées en premier 
	(plus grand au plus petit nombre de cartes de crédit).

	Répondez aux questions suivantes: 
	1) Combien est-ce que les clients (Individual Customer) et les store contact ont de cartes de crédit au total ? 
	2) Est-ce que certains types de personnes n'ont aucune carte de crédit? 

*/


-- Information pour le correcteur : d'une manière ou d'une autre, cette requête est assez longue à exécuter.
	
SELECT
	CASE --Je dois compter et différencier les différents sous-groupes de PersonType et je peux le faire avec CASE: https://www.w3schools.com/sql/sql_case.asp
        WHEN Person.PersonType = 'EM' THEN 'Employée'
        WHEN Person.PersonType = 'SP' THEN 'Vendeur'
		WHEN Person.PersonType = 'SC' THEN 'Contact magasin'
		WHEN Person.PersonType = 'IN' THEN 'Particulier (commerce de détail) client'
		WHEN Person.PersonType = 'VC' THEN 'Contact Vendeur'
		WHEN Person.PersonType = 'GC' THEN 'Contact General'
    END,
	COUNT(DISTINCT Sales.CreditCard.CreditCardID) AS NombreDeCartesCredit -- Je dois sélectionner et compter les numéros de cartes de crédit par groupe.
FROM Person.Person -- table A
LEFT JOIN Sales.SalesOrderHeader ON Person.BusinessEntityID = Sales.SalesOrderHeader.CustomerID -- un LEFT JOIN avec table B; CostumerID ne figure pas dans le graphique de 2008 mais dans AdventureWork 2017 et 2019 selon ce guide : https://dataedo.com/download/AdventureWorks.pdf
LEFT JOIN Sales.CreditCard ON Sales.SalesOrderHeader.CreditCardID = Sales.CreditCard.CreditCardID
GROUP BY
    CASE
        WHEN Person.PersonType = 'EM' THEN 'Employée'
        WHEN Person.PersonType = 'SP' THEN 'Vendeur'
		WHEN Person.PersonType = 'SC' THEN 'Contact magasin'
		WHEN Person.PersonType = 'IN' THEN 'Particulier (commerce de détail) client'
		WHEN Person.PersonType = 'VC' THEN 'Contact Vendeur'
		WHEN Person.PersonType = 'GC' THEN 'Contact General'
    END
ORDER BY
    NombreDeCartesCredit DESC;

--1) En total, il y 9403cartes de crédit.
--2) Oui, le seul groupe disposant d'une carte de crédit dans cette base de données est celui des clients.


